#!/bin/bash
source ~/.bash_profile
home_path=$(cd "`dirname $0`"; pwd)
day_time=`date -d "1 day ago" +"%Y-%m-%d"`
day5_time=`date -d "5 day ago" +"%Y-%m-%d"`



hive -e "set mapred.job.queue.name=q_gmv;
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nostrict;
set hive.groupby.skewindata=true;
set hive.exec.parallel=true;
set mapred.reduce.tasks=10;
USE RECOMMEND;
DROP TABLE FEATURE_CLICK_DRAFT1;
DROP TABLE FEATURE_CLICK_DRAFT2;
DROP TABLE feature_up_level2;


CREATE TABLE FEATURE_CLICK_DRAFT1 AS SELECT user_proxy_key,CONCAT_WS(',', COLLECT_SET(concat(tag_id,':',user_tag_weight))) AS tag_str_draft from recommend.dw_cp_user_preference_30_days where ds='$day_time' and tag_id regexp 'cate_' and tag_id in ('cate_9','cate_11','cate_29','cate_31','cate_33','cate_35','cate_39','cate_43','cate_45','cate_47','cate_49','cate_51','cate_53','cate_55','cate_59','cate_61','cate_63','cate_65','cate_67','cate_69','cate_73','cate_77','cate_79','cate_81','cate_83','cate_85','cate_87','cate_89','cate_91','cate_97','cate_101','cate_105','cate_111','cate_115','cate_117','cate_119','cate_121','cate_123','cate_127','cate_129','cate_133','cate_135','cate_137','cate_139','cate_143','cate_145','cate_149','cate_151','cate_157','cate_159','cate_165','cate_169','cate_171','cate_173','cate_175','cate_179','cate_183','cate_185','cate_187','cate_189','cate_193','cate_195','cate_197','cate_199','cate_251','cate_589','cate_813','cate_961','cate_981','cate_985','cate_997','cate_999','cate_1137','cate_1519','cate_1521','cate_1525','cate_1537','cate_1565','cate_1623','cate_1625','cate_1627','cate_1635','cate_1641','cate_1643','cate_1693','cate_1745','cate_1967','cate_2067','cate_2911','cate_3961','cate_4373','cate_4397','cate_4809','cate_4845','cate_4887','cate_4939','cate_5329','cate_5331','cate_5338','cate_5339','cate_5340','cate_5382','cate_5383','cate_5385','cate_5386','cate_5387','cate_5388','cate_5389','cate_5402','cate_5422','cate_5423','cate_5467','cate_5471','cate_5562') GROUP BY user_proxy_key;

CREATE TABLE FEATURE_CLICK_DRAFT2 AS SELECT user_proxy_key, regexp_extract(tag_str_draft,'cate_9:(.*?)(,|$)', 1) AS cate_9,regexp_extract(tag_str_draft,'cate_11:(.*?)(,|$)',1) as cate_11,regexp_extract(tag_str_draft,'cate_29:(.*?)(,|$)',1) as cate_29,regexp_extract(tag_str_draft,'cate_31:(.*?)(,|$)',1) as cate_31,regexp_extract(tag_str_draft,'cate_33:(.*?)(,|$)',1) as cate_33,regexp_extract(tag_str_draft,'cate_35:(.*?)(,|$)',1) as cate_35,regexp_extract(tag_str_draft,'cate_39:(.*?)(,|$)',1) as cate_39,regexp_extract(tag_str_draft,'cate_43:(.*?)(,|$)',1) as cate_43,regexp_extract(tag_str_draft,'cate_45:(.*?)(,|$)',1) as cate_45,regexp_extract(tag_str_draft,'cate_47:(.*?)(,|$)',1) as cate_47,regexp_extract(tag_str_draft,'cate_49:(.*?)(,|$)',1) as cate_49,regexp_extract(tag_str_draft,'cate_51:(.*?)(,|$)',1) as cate_51,regexp_extract(tag_str_draft,'cate_53:(.*?)(,|$)',1) as cate_53,regexp_extract(tag_str_draft,'cate_55:(.*?)(,|$)',1) as cate_55,regexp_extract(tag_str_draft,'cate_59:(.*?)(,|$)',1) as cate_59,regexp_extract(tag_str_draft,'cate_61:(.*?)(,|$)',1) as cate_61,regexp_extract(tag_str_draft,'cate_63:(.*?)(,|$)',1) as cate_63,regexp_extract(tag_str_draft,'cate_65:(.*?)(,|$)',1) as cate_65,regexp_extract(tag_str_draft,'cate_67:(.*?)(,|$)',1) as cate_67,regexp_extract(tag_str_draft,'cate_69:(.*?)(,|$)',1) as cate_69,regexp_extract(tag_str_draft,'cate_73:(.*?)(,|$)',1) as cate_73,regexp_extract(tag_str_draft,'cate_77:(.*?)(,|$)',1) as cate_77,regexp_extract(tag_str_draft,'cate_79:(.*?)(,|$)',1) as cate_79,regexp_extract(tag_str_draft,'cate_81:(.*?)(,|$)',1) as cate_81,regexp_extract(tag_str_draft,'cate_83:(.*?)(,|$)',1) as cate_83,regexp_extract(tag_str_draft,'cate_85:(.*?)(,|$)',1) as cate_85,regexp_extract(tag_str_draft,'cate_87:(.*?)(,|$)',1) as cate_87,regexp_extract(tag_str_draft,'cate_89:(.*?)(,|$)',1) as cate_89,regexp_extract(tag_str_draft,'cate_91:(.*?)(,|$)',1) as cate_91,regexp_extract(tag_str_draft,'cate_97:(.*?)(,|$)',1) as cate_97,regexp_extract(tag_str_draft,'cate_101:(.*?)(,|$)',1) as cate_101,regexp_extract(tag_str_draft,'cate_105:(.*?)(,|$)',1) as cate_105,regexp_extract(tag_str_draft,'cate_111:(.*?)(,|$)',1) as cate_111,regexp_extract(tag_str_draft,'cate_115:(.*?)(,|$)',1) as cate_115,regexp_extract(tag_str_draft,'cate_117:(.*?)(,|$)',1) as cate_117,regexp_extract(tag_str_draft,'cate_119:(.*?)(,|$)',1) as cate_119,regexp_extract(tag_str_draft,'cate_121:(.*?)(,|$)',1) as cate_121,regexp_extract(tag_str_draft,'cate_123:(.*?)(,|$)',1) as cate_123,regexp_extract(tag_str_draft,'cate_127:(.*?)(,|$)',1) as cate_127,regexp_extract(tag_str_draft,'cate_129:(.*?)(,|$)',1) as cate_129,regexp_extract(tag_str_draft,'cate_133:(.*?)(,|$)',1) as cate_133,regexp_extract(tag_str_draft,'cate_135:(.*?)(,|$)',1) as cate_135,regexp_extract(tag_str_draft,'cate_137:(.*?)(,|$)',1) as cate_137,regexp_extract(tag_str_draft,'cate_139:(.*?)(,|$)',1) as cate_139,regexp_extract(tag_str_draft,'cate_143:(.*?)(,|$)',1) as cate_143,regexp_extract(tag_str_draft,'cate_145:(.*?)(,|$)',1) as cate_145,regexp_extract(tag_str_draft,'cate_149:(.*?)(,|$)',1) as cate_149,regexp_extract(tag_str_draft,'cate_151:(.*?)(,|$)',1) as cate_151,regexp_extract(tag_str_draft,'cate_157:(.*?)(,|$)',1) as cate_157,regexp_extract(tag_str_draft,'cate_159:(.*?)(,|$)',1) as cate_159,regexp_extract(tag_str_draft,'cate_165:(.*?)(,|$)',1) as cate_165,regexp_extract(tag_str_draft,'cate_169:(.*?)(,|$)',1) as cate_169,regexp_extract(tag_str_draft,'cate_171:(.*?)(,|$)',1) as cate_171,regexp_extract(tag_str_draft,'cate_173:(.*?)(,|$)',1) as cate_173,regexp_extract(tag_str_draft,'cate_175:(.*?)(,|$)',1) as cate_175,regexp_extract(tag_str_draft,'cate_179:(.*?)(,|$)',1) as cate_179,regexp_extract(tag_str_draft,'cate_183:(.*?)(,|$)',1) as cate_183,regexp_extract(tag_str_draft,'cate_185:(.*?)(,|$)',1) as cate_185,regexp_extract(tag_str_draft,'cate_187:(.*?)(,|$)',1) as cate_187,regexp_extract(tag_str_draft,'cate_189:(.*?)(,|$)',1) as cate_189,regexp_extract(tag_str_draft,'cate_193:(.*?)(,|$)',1) as cate_193,regexp_extract(tag_str_draft,'cate_195:(.*?)(,|$)',1) as cate_195,regexp_extract(tag_str_draft,'cate_197:(.*?)(,|$)',1) as cate_197,regexp_extract(tag_str_draft,'cate_199:(.*?)(,|$)',1) as cate_199,regexp_extract(tag_str_draft,'cate_251:(.*?)(,|$)',1) as cate_251,regexp_extract(tag_str_draft,'cate_589:(.*?)(,|$)',1) as cate_589,regexp_extract(tag_str_draft,'cate_813:(.*?)(,|$)',1) as cate_813,regexp_extract(tag_str_draft,'cate_961:(.*?)(,|$)',1) as cate_961,regexp_extract(tag_str_draft,'cate_981:(.*?)(,|$)',1) as cate_981,regexp_extract(tag_str_draft,'cate_985:(.*?)(,|$)',1) as cate_985,regexp_extract(tag_str_draft,'cate_997:(.*?)(,|$)',1) as cate_997,regexp_extract(tag_str_draft,'cate_999:(.*?)(,|$)',1) as cate_999,regexp_extract(tag_str_draft,'cate_1137:(.*?)(,|$)',1) as cate_1137,regexp_extract(tag_str_draft,'cate_1519:(.*?)(,|$)',1) as cate_1519,regexp_extract(tag_str_draft,'cate_1521:(.*?)(,|$)',1) as cate_1521,regexp_extract(tag_str_draft,'cate_1525:(.*?)(,|$)',1) as cate_1525,regexp_extract(tag_str_draft,'cate_1537:(.*?)(,|$)',1) as cate_1537,regexp_extract(tag_str_draft,'cate_1565:(.*?)(,|$)',1) as cate_1565,regexp_extract(tag_str_draft,'cate_1623:(.*?)(,|$)',1) as cate_1623,regexp_extract(tag_str_draft,'cate_1625:(.*?)(,|$)',1) as cate_1625,regexp_extract(tag_str_draft,'cate_1627:(.*?)(,|$)',1) as cate_1627,regexp_extract(tag_str_draft,'cate_1635:(.*?)(,|$)',1) as cate_1635,regexp_extract(tag_str_draft,'cate_1641:(.*?)(,|$)',1) as cate_1641,regexp_extract(tag_str_draft,'cate_1643:(.*?)(,|$)',1) as cate_1643,regexp_extract(tag_str_draft,'cate_1693:(.*?)(,|$)',1) as cate_1693,regexp_extract(tag_str_draft,'cate_1745:(.*?)(,|$)',1) as cate_1745,regexp_extract(tag_str_draft,'cate_1967:(.*?)(,|$)',1) as cate_1967,regexp_extract(tag_str_draft,'cate_2067:(.*?)(,|$)',1) as cate_2067,regexp_extract(tag_str_draft,'cate_2911:(.*?)(,|$)',1) as cate_2911,regexp_extract(tag_str_draft,'cate_3961:(.*?)(,|$)',1) as cate_3961,regexp_extract(tag_str_draft,'cate_4373:(.*?)(,|$)',1) as cate_4373,regexp_extract(tag_str_draft,'cate_4397:(.*?)(,|$)',1) as cate_4397,regexp_extract(tag_str_draft,'cate_4809:(.*?)(,|$)',1) as cate_4809,regexp_extract(tag_str_draft,'cate_4845:(.*?)(,|$)',1) as cate_4845,regexp_extract(tag_str_draft,'cate_4887:(.*?)(,|$)',1) as cate_4887,regexp_extract(tag_str_draft,'cate_4939:(.*?)(,|$)',1) as cate_4939,regexp_extract(tag_str_draft,'cate_5329:(.*?)(,|$)',1) as cate_5329,regexp_extract(tag_str_draft,'cate_5331:(.*?)(,|$)',1) as cate_5331,regexp_extract(tag_str_draft,'cate_5338:(.*?)(,|$)',1) as cate_5338,regexp_extract(tag_str_draft,'cate_5339:(.*?)(,|$)',1) as cate_5339,regexp_extract(tag_str_draft,'cate_5340:(.*?)(,|$)',1) as cate_5340,regexp_extract(tag_str_draft,'cate_5382:(.*?)(,|$)',1) as cate_5382,regexp_extract(tag_str_draft,'cate_5383:(.*?)(,|$)',1) as cate_5383,regexp_extract(tag_str_draft,'cate_5385:(.*?)(,|$)',1) as cate_5385,regexp_extract(tag_str_draft,'cate_5386:(.*?)(,|$)',1) as cate_5386,regexp_extract(tag_str_draft,'cate_5387:(.*?)(,|$)',1) as cate_5387,regexp_extract(tag_str_draft,'cate_5388:(.*?)(,|$)',1) as cate_5388,regexp_extract(tag_str_draft,'cate_5389:(.*?)(,|$)',1) as cate_5389,regexp_extract(tag_str_draft,'cate_5402:(.*?)(,|$)',1) as cate_5402,regexp_extract(tag_str_draft,'cate_5422:(.*?)(,|$)',1) as cate_5422,regexp_extract(tag_str_draft,'cate_5423:(.*?)(,|$)',1) as cate_5423,regexp_extract(tag_str_draft,'cate_5467:(.*?)(,|$)',1) as cate_5467,regexp_extract(tag_str_draft,'cate_5471:(.*?)(,|$)',1) as cate_5471,regexp_extract(tag_str_draft,'cate_5562:(.*?)(,|$)',1) as cate_5562 FROM FEATURE_CLICK_DRAFT1;


CREATE TABLE feature_up_level2 AS SELECT user_proxy_key as device_id_level2, case when cate_9<>'' then cate_9 else 0 end AS cate_9,case when cate_11<>'' then cate_11 else 0 end as cate_11,case when cate_29<>'' then cate_29 else 0 end as cate_29,case when cate_31<>'' then cate_31 else 0 end as cate_31,case when cate_33<>'' then cate_33 else 0 end as cate_33,case when cate_35<>'' then cate_35 else 0 end as cate_35,case when cate_39<>'' then cate_39 else 0 end as cate_39,case when cate_43<>'' then cate_43 else 0 end as cate_43,case when cate_45<>'' then cate_45 else 0 end as cate_45,case when cate_47<>'' then cate_47 else 0 end as cate_47,case when cate_49<>'' then cate_49 else 0 end as cate_49,case when cate_51<>'' then cate_51 else 0 end as cate_51,case when cate_53<>'' then cate_53 else 0 end as cate_53,case when cate_55<>'' then cate_55 else 0 end as cate_55,case when cate_59<>'' then cate_59 else 0 end as cate_59,case when cate_61<>'' then cate_61 else 0 end as cate_61,case when cate_63<>'' then cate_63 else 0 end as cate_63,case when cate_65<>'' then cate_65 else 0 end as cate_65,case when cate_67<>'' then cate_67 else 0 end as cate_67,case when cate_69<>'' then cate_69 else 0 end as cate_69,case when cate_73<>'' then cate_73 else 0 end as cate_73,case when cate_77<>'' then cate_77 else 0 end as cate_77,case when cate_79<>'' then cate_79 else 0 end as cate_79,case when cate_81<>'' then cate_81 else 0 end as cate_81,case when cate_83<>'' then cate_83 else 0 end as cate_83,case when cate_85<>'' then cate_85 else 0 end as cate_85,case when cate_87<>'' then cate_87 else 0 end as cate_87,case when cate_89<>'' then cate_89 else 0 end as cate_89,case when cate_91<>'' then cate_91 else 0 end as cate_91,case when cate_97<>'' then cate_97 else 0 end as cate_97,case when cate_101<>'' then cate_101 else 0 end as cate_101,case when cate_105<>'' then cate_105 else 0 end as cate_105,case when cate_111<>'' then cate_111 else 0 end as cate_111,case when cate_115<>'' then cate_115 else 0 end as cate_115,case when cate_117<>'' then cate_117 else 0 end as cate_117,case when cate_119<>'' then cate_119 else 0 end as cate_119,case when cate_121<>'' then cate_121 else 0 end as cate_121,case when cate_123<>'' then cate_123 else 0 end as cate_123,case when cate_127<>'' then cate_127 else 0 end as cate_127,case when cate_129<>'' then cate_129 else 0 end as cate_129,case when cate_133<>'' then cate_133 else 0 end as cate_133,case when cate_135<>'' then cate_135 else 0 end as cate_135,case when cate_137<>'' then cate_137 else 0 end as cate_137,case when cate_139<>'' then cate_139 else 0 end as cate_139,case when cate_143<>'' then cate_143 else 0 end as cate_143,case when cate_145<>'' then cate_145 else 0 end as cate_145,case when cate_149<>'' then cate_149 else 0 end as cate_149,case when cate_151<>'' then cate_151 else 0 end as cate_151,case when cate_157<>'' then cate_157 else 0 end as cate_157,case when cate_159<>'' then cate_159 else 0 end as cate_159,case when cate_165<>'' then cate_165 else 0 end as cate_165,case when cate_169<>'' then cate_169 else 0 end as cate_169,case when cate_171<>'' then cate_171 else 0 end as cate_171,case when cate_173<>'' then cate_173 else 0 end as cate_173,case when cate_175<>'' then cate_175 else 0 end as cate_175,case when cate_179<>'' then cate_179 else 0 end as cate_179,case when cate_183<>'' then cate_183 else 0 end as cate_183,case when cate_185<>'' then cate_185 else 0 end as cate_185,case when cate_187<>'' then cate_187 else 0 end as cate_187,case when cate_189<>'' then cate_189 else 0 end as cate_189,case when cate_193<>'' then cate_193 else 0 end as cate_193,case when cate_195<>'' then cate_195 else 0 end as cate_195,case when cate_197<>'' then cate_197 else 0 end as cate_197,case when cate_199<>'' then cate_199 else 0 end as cate_199,case when cate_251<>'' then cate_251 else 0 end as cate_251,case when cate_589<>'' then cate_589 else 0 end as cate_589,case when cate_813<>'' then cate_813 else 0 end as cate_813,case when cate_961<>'' then cate_961 else 0 end as cate_961,case when cate_981<>'' then cate_981 else 0 end as cate_981,case when cate_985<>'' then cate_985 else 0 end as cate_985,case when cate_997<>'' then cate_997 else 0 end as cate_997,case when cate_999<>'' then cate_999 else 0 end as cate_999,case when cate_1137<>'' then cate_1137 else 0 end as cate_1137,case when cate_1519<>'' then cate_1519 else 0 end as cate_1519,case when cate_1521<>'' then cate_1521 else 0 end as cate_1521,case when cate_1525<>'' then cate_1525 else 0 end as cate_1525,case when cate_1537<>'' then cate_1537 else 0 end as cate_1537,case when cate_1565<>'' then cate_1565 else 0 end as cate_1565,case when cate_1623<>'' then cate_1623 else 0 end as cate_1623,case when cate_1625<>'' then cate_1625 else 0 end as cate_1625,case when cate_1627<>'' then cate_1627 else 0 end as cate_1627,case when cate_1635<>'' then cate_1635 else 0 end as cate_1635,case when cate_1641<>'' then cate_1641 else 0 end as cate_1641,case when cate_1643<>'' then cate_1643 else 0 end as cate_1643,case when cate_1693<>'' then cate_1693 else 0 end as cate_1693,case when cate_1745<>'' then cate_1745 else 0 end as cate_1745,case when cate_1967<>'' then cate_1967 else 0 end as cate_1967,case when cate_2067<>'' then cate_2067 else 0 end as cate_2067,case when cate_2911<>'' then cate_2911 else 0 end as cate_2911,case when cate_3961<>'' then cate_3961 else 0 end as cate_3961,case when cate_4373<>'' then cate_4373 else 0 end as cate_4373,case when cate_4397<>'' then cate_4397 else 0 end as cate_4397,case when cate_4809<>'' then cate_4809 else 0 end as cate_4809,case when cate_4845<>'' then cate_4845 else 0 end as cate_4845,case when cate_4887<>'' then cate_4887 else 0 end as cate_4887,case when cate_4939<>'' then cate_4939 else 0 end as cate_4939,case when cate_5329<>'' then cate_5329 else 0 end as cate_5329,case when cate_5331<>'' then cate_5331 else 0 end as cate_5331,case when cate_5338<>'' then cate_5338 else 0 end as cate_5338,case when cate_5339<>'' then cate_5339 else 0 end as cate_5339,case when cate_5340<>'' then cate_5340 else 0 end as cate_5340,case when cate_5382<>'' then cate_5382 else 0 end as cate_5382,case when cate_5383<>'' then cate_5383 else 0 end as cate_5383,case when cate_5385<>'' then cate_5385 else 0 end as cate_5385,case when cate_5386<>'' then cate_5386 else 0 end as cate_5386,case when cate_5387<>'' then cate_5387 else 0 end as cate_5387,case when cate_5388<>'' then cate_5388 else 0 end as cate_5388,case when cate_5389<>'' then cate_5389 else 0 end as cate_5389,case when cate_5402<>'' then cate_5402 else 0 end as cate_5402,case when cate_5422<>'' then cate_5422 else 0 end as cate_5422,case when cate_5423<>'' then cate_5423 else 0 end as cate_5423,case when cate_5467<>'' then cate_5467 else 0 end as cate_5467,case when cate_5471<>'' then cate_5471 else 0 end as cate_5471,case when cate_5562<>'' then cate_5562 else 0 end as cate_5562 from FEATURE_CLICK_DRAFT2;

"
